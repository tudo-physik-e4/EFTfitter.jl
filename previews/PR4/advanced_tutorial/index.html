<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced Tutorial · EFTfitter.jl</title><link rel="canonical" href="https://github.com/tudo-physik-e4/EFTfitter.jl/advanced_tutorial/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">EFTfitter.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><a class="tocitem" href="../tutorial/">Tutorial</a></li><li class="is-active"><a class="tocitem" href>Advanced Tutorial</a><ul class="internal"><li><a class="tocitem" href="#Vector-of-functions-for-a-MeasurementDistribution-1"><span>Vector of functions for a MeasurementDistribution</span></a></li><li><a class="tocitem" href="#Using-covariance-matrices-1"><span>Using covariance matrices</span></a></li><li><a class="tocitem" href="#Nuisance-Correlations-1"><span>Nuisance Correlations</span></a></li><li><a class="tocitem" href="#Ranking-of-measurements-and-uncertainties-1"><span>Ranking of measurements and uncertainties</span></a></li></ul></li><li><a class="tocitem" href="../BLUE/">BLUE Example</a></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../LICENSE/">LICENSE</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Advanced Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/tudo-physik-e4/EFTfitter.jl/blob/master/docs/src/advanced_tutorial.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="EFTfitter.jl-Advanced-Tutorial-1"><a class="docs-heading-anchor" href="#EFTfitter.jl-Advanced-Tutorial-1">EFTfitter.jl - Advanced Tutorial</a><a class="docs-heading-anchor-permalink" href="#EFTfitter.jl-Advanced-Tutorial-1" title="Permalink"></a></h1><p>Table of contents:</p><ul><li><a href="#EFTfitter.jl-Advanced-Tutorial-1">EFTfitter.jl - Advanced Tutorial</a></li><ul><li><a href="#Vector-of-functions-for-a-MeasurementDistribution-1">Vector of functions for a MeasurementDistribution</a></li><li><a href="#Using-covariance-matrices-1">Using covariance matrices</a></li><li><a href="#Nuisance-Correlations-1">Nuisance Correlations</a></li><li><a href="#Ranking-of-measurements-and-uncertainties-1">Ranking of measurements and uncertainties</a></li></ul></ul><h2 id="Vector-of-functions-for-a-MeasurementDistribution-1"><a class="docs-heading-anchor" href="#Vector-of-functions-for-a-MeasurementDistribution-1">Vector of functions for a MeasurementDistribution</a><a class="docs-heading-anchor-permalink" href="#Vector-of-functions-for-a-MeasurementDistribution-1" title="Permalink"></a></h2><p>When using distributions of measurements, a vector of functions with the predictions for the observable needs to be passed containing a function for each of the bins which have only the model parameters as their argument. Defining a separate function for each bin can, however, become tedious for a large number of bins, especially since typically the bins of a distribution have a similar functional dependence on the model parameters and only differ in some coefficients. In such cases, it is possible to use Julia&#39;s <a href="https://docs.julialang.org/en/v1/manual/metaprogramming/">metaprogramming</a> features to create the vector of functions. The distribution in our <a href="https://tudo-physik-e4.github.io/EFTfitter.jl/dev/tutorial/">basic tutorial</a> has been defined by implementing three functions that all call the same function <code>myfunc</code> but with different values for the coefficients The same result can also be achieved like this:</p><pre><code class="language-julia">function get_coeffs(i) # return the coefficients for bin i
    coeffs = [[2.2, 5.5, 6.6], [2.2, 5.5, 6.6], [2.2, 5.5, 6.6]]
    return coeffs[i]
end

function my_dist_func(params, i)
    coeffs = get_coeffs(i)
    return coeffs[1] * params.C1 + coeffs[2] * params.C1 * params.C2+ coeffs[3] * params.C2
end</code></pre><p>create an array of Functions with names <code>diff_xsec_binX</code>:</p><pre><code class="language-julia">diff_xsec=Function[]
for i in 1:3
    @eval begin
        function $(Symbol(&quot;diff_xsec_bin$i&quot;))(params)
            return my_dist_func(params, $i)
        end
        push!(diff_xsec, $(Symbol(&quot;diff_xsec_bin$i&quot;)))
    end
end</code></pre><h2 id="Using-covariance-matrices-1"><a class="docs-heading-anchor" href="#Using-covariance-matrices-1">Using covariance matrices</a><a class="docs-heading-anchor-permalink" href="#Using-covariance-matrices-1" title="Permalink"></a></h2><p>Information about the uncertainties of measurements need to be provided to EFTfitter.jl in terms of the uncertainty values and corresponding correlation matrices. If you have these information in terms of covariance matrices, you need to convert it to correlation matrices and uncertainty values before. The function <a href="https://tudo-physik-e4.github.io/EFTfitter.jl/dev/api/#EFTfitter.cov_to_cor-Tuple{Array{var%22#s58%22,2}%20where%20var%22#s58%22%3C:Real}"><code>cov_to_cor</code></a> can be used for this:</p><pre><code class="language-julia">cov_syst = [3.24   0.81   0.378  0.324  0.468;
            0.81   0.81   0.126  0.162  0.234;
            0.378  0.126  0.49   0.126  0.182;
            0.324  0.162  0.126  0.81   0.234;
            0.468  0.234  0.182  0.234  1.69]

cor_syst, unc_syst = cov_to_cor(cov_syst)</code></pre><pre><code class="language-julia">measurements = (

    Meas1 = Measurement(xsec1, 21.6,
            uncertainties = (stat=0.8, syst=unc_syst[1], another_unc=2.3)),

    Meas2 = Measurement(Observable(xsec2, min=0), 1.9,
            uncertainties = (stat=0.6, syst=unc_syst[2], another_unc=1.1), active=true),


    MeasDist = MeasurementDistribution(diff_xsec, [1.9, 2.93, 4.4],
                uncertainties = (stat = [0.7, 1.1, 1.2], syst= unc_syst[3:5], another_unc = [1.0, 1.2, 1.9]),
                active=[true, false, true]),
)</code></pre><h2 id="Nuisance-Correlations-1"><a class="docs-heading-anchor" href="#Nuisance-Correlations-1">Nuisance Correlations</a><a class="docs-heading-anchor-permalink" href="#Nuisance-Correlations-1" title="Permalink"></a></h2><p>When performing an analysis with unknown correlation coefficients, it is possible to treat them as nuisance parameters in the fit. For this, we define a further <code>NamedTuple</code> consisting of <code>NuisanceCorrelation</code> objects:</p><pre><code class="language-julia">nuisance_correlations = (
    ρ1  = NuisanceCorrelation(:syst, :Meas1, :Meas2, -1..1),
    ρ2  = NuisanceCorrelation(:syst, :MeasDist_bin1, :MeasDist_bin3, truncated(Normal(0.5, 0.1), -1, 1)),
)</code></pre><p>In the <code>NuisanceCorrelation</code> object we specify the name of the uncertainty type, the names of the two measurements we want to correlate using the nuisance correlations and a prior for the nuisance parameter. Note that the nuisance parameters should only be varied in the interval (-1, 1) as they represent correlation coefficients. For <code>ρ1</code> we choose a flat prior between -1 and 1. For <code>ρ2</code> we have some expectations and formulate them using a Gaussian prior with μ=0.5 and σ=0.1. However, to ensure that <code>ρ2</code> is only varied in the allowed region of (-1, 1), we <a href="https://juliastats.org/Distributions.jl/stable/truncate/#Distributions.truncated">truncate</a> the normal distribution accordingly.</p><p>We need to modify the definition of the <code>EFTfitterModel</code> by also passing the <code>nuisance_correlations</code>:</p><pre><code class="language-julia">model = EFTfitterModel(parameters, measurements, correlations, nuisance_correlations)


savefig(p, &quot;plot.pdf&quot;)</code></pre><p><img src="../plots/plot_nuisance.png" alt="plot with nuisances"/></p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>When using nuisance correlations, it may happen that the fit does not converge anymore. This happens mainly when the correlation values are close to -1 or +1. In such a case, you can try to reduce the allowed ranges in the priors for the Nuisance correlations to investigate at which values this happens.</p></div></div><h2 id="Ranking-of-measurements-and-uncertainties-1"><a class="docs-heading-anchor" href="#Ranking-of-measurements-and-uncertainties-1">Ranking of measurements and uncertainties</a><a class="docs-heading-anchor-permalink" href="#Ranking-of-measurements-and-uncertainties-1" title="Permalink"></a></h2><p>With the <code>rank_measurements</code> and <code>rank_uncertainties</code> functions, the influence of the individual measurements or uncertainty types on the result of a fit can be estimated. For the ranking, each active measurement (respectively uncertainty type) is deactivated at a time and the fit is repeated. The results of the fits with a deactivated measurement (or uncertainty type) are then compared to the fit result with all measurements (uncertainty types) activated. A ranking is calculated based on a ranking criterion calculated from the posterior distributions of these fits.</p><p>The default ranking criterion is the relative increase of the total width of the smallest interval containing 90% of the posterior probability when deactivating a measurement. For models with more than one parameter, the sum of the relative increases of all one-dimensional smallest intervals is used, i.e. <code>SumOfSmallestIntervals(p=0.9, bins=200)</code>.</p><pre><code class="language-julia">measurement_ranking = EFTfitter.rank_measurements(model)</code></pre><p>The sampling algorithm to be used can be passed with the keyword <code>sampling_algorithm</code>. By default, <code>BAT.MCMCSampling()</code> is used, i.e. Metropolis-Hastings with 4 chains and 100000 steps.</p><pre><code class="language-julia">plot(measurement_ranking, title = &quot;Ranking of measurements&quot;)</code></pre><p><img src="../plots/meas_ranks.png" alt="measurement ranking"/></p><p>For ranking the uncertainty types, the relative decrease is used.</p><pre><code class="language-julia">uncertainty_ranking = EFTfitter.rank_uncertainties(model,
    criterion = SumOfSmallestIntervals(p=0.9, bins=200),
    sampling_algorithm = SobolSampler(nsamples = 10^5), order = :values)

plot(uncertainty_ranking, title = &quot;Ranking of uncertainty types&quot;)</code></pre><p><img src="../plots/unc_ranks.png" alt="measurement ranking"/> Please see the <a href="https://tudo-physik-e4.github.io/EFTfitter.jl/dev/api/#EFTfitter.rank_measurements">ranking documentation</a> for further ranking criteria and keyword arguments.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tutorial/">« Tutorial</a><a class="docs-footer-nextpage" href="../BLUE/">BLUE Example »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 3 May 2021 00:45">Monday 3 May 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
