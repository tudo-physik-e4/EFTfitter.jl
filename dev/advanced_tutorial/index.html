<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced Tutorial · EFTfitter.jl</title><meta name="title" content="Advanced Tutorial · EFTfitter.jl"/><meta property="og:title" content="Advanced Tutorial · EFTfitter.jl"/><meta property="twitter:title" content="Advanced Tutorial · EFTfitter.jl"/><meta name="description" content="Documentation for EFTfitter.jl."/><meta property="og:description" content="Documentation for EFTfitter.jl."/><meta property="twitter:description" content="Documentation for EFTfitter.jl."/><meta property="og:url" content="https://github.com/tudo-physik-e4/EFTfitter.jl/advanced_tutorial/"/><meta property="twitter:url" content="https://github.com/tudo-physik-e4/EFTfitter.jl/advanced_tutorial/"/><link rel="canonical" href="https://github.com/tudo-physik-e4/EFTfitter.jl/advanced_tutorial/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">EFTfitter.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><a class="tocitem" href="../tutorial/">Tutorial</a></li><li class="is-active"><a class="tocitem" href>Advanced Tutorial</a><ul class="internal"><li><a class="tocitem" href="#Model-uncertainties"><span>Model uncertainties</span></a></li><li><a class="tocitem" href="#Vector-of-functions-for-a-BinnedMeasurement"><span>Vector of functions for a BinnedMeasurement</span></a></li><li><a class="tocitem" href="#Using-covariance-matrices"><span>Using covariance matrices</span></a></li><li><a class="tocitem" href="#Nuisance-Correlations"><span>Nuisance Correlations</span></a></li><li><a class="tocitem" href="#Ranking-of-measurements-and-uncertainties"><span>Ranking of measurements and uncertainties</span></a></li></ul></li><li><a class="tocitem" href="../BLUE/">BLUE Example</a></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../LICENSE/">LICENSE</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Advanced Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/tudo-physik-e4/EFTfitter.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/tudo-physik-e4/EFTfitter.jl/blob/main/docs/src/advanced_tutorial.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="EFTfitter.jl-Advanced-Tutorial"><a class="docs-heading-anchor" href="#EFTfitter.jl-Advanced-Tutorial">EFTfitter.jl - Advanced Tutorial</a><a id="EFTfitter.jl-Advanced-Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#EFTfitter.jl-Advanced-Tutorial" title="Permalink"></a></h1><p>Table of contents:</p><ul><li><a href="#EFTfitter.jl-Advanced-Tutorial">EFTfitter.jl - Advanced Tutorial</a></li><li class="no-marker"><ul><li><a href="#Model-uncertainties">Model uncertainties</a></li><li><a href="#Vector-of-functions-for-a-BinnedMeasurement">Vector of functions for a BinnedMeasurement</a></li><li><a href="#Using-covariance-matrices">Using covariance matrices</a></li><li><a href="#Nuisance-Correlations">Nuisance Correlations</a></li><li><a href="#Ranking-of-measurements-and-uncertainties">Ranking of measurements and uncertainties</a></li></ul></li></ul><h2 id="Model-uncertainties"><a class="docs-heading-anchor" href="#Model-uncertainties">Model uncertainties</a><a id="Model-uncertainties-1"></a><a class="docs-heading-anchor-permalink" href="#Model-uncertainties" title="Permalink"></a></h2><p>The predictions for the observables can be affected by uncertainties that dependend on the current value of the model parameters. Such uncertainties can be included in the analysis by letting the observable functions return a tuple of numbers, where the first number is the prediction and the second number is the absolute uncertainty on that prediction.</p><pre><code class="language-julia hljs">function xsec1(params)
    coeffs = [20.12, 5.56, 325.556]
    prediction = myfunc(params, coeffs)
    uncertainty = 0.1 * prediction # assume a 10% uncertainty
    return (prediction, uncertainty)
end</code></pre><p>Note: It is possible to specify a model uncertainty only for some of the observables. When the observable functions returns a single number, EFTfitter.jl will assume that the model uncertainty is zero for this observable. However, please note that as soon as one observable function returns a tuple, the runtime of the model will probably increase, as the model uncertainties then need to be evaluate in each step. Therefore, model uncertainties should only be used when the uncertainty value is depending on the model parameters. Constant uncertainties should just be specified in the <code>uncertainties</code> field of the measurements.</p><h2 id="Vector-of-functions-for-a-BinnedMeasurement"><a class="docs-heading-anchor" href="#Vector-of-functions-for-a-BinnedMeasurement">Vector of functions for a BinnedMeasurement</a><a id="Vector-of-functions-for-a-BinnedMeasurement-1"></a><a class="docs-heading-anchor-permalink" href="#Vector-of-functions-for-a-BinnedMeasurement" title="Permalink"></a></h2><p>When using binned measurements, a vector of functions giving the predictions for the observable needs to be passed. It contains a function for each of bin and has only the model parameters as its argument. Defining a separate function for each bin can, however, become tedious for a large number of bins, especially since typically the bins of a distribution have a similar functional dependence on the model parameters and only differ in some coefficients. In such cases, it is possible to use Julia&#39;s anonymous functions to quickly create the vector of functions. The distribution in our <a href="https://tudo-physik-e4.github.io/EFTfitter.jl/dev/tutorial/">basic tutorial</a> has been defined by implementing three functions that all call the same function <code>myfunc</code> but with different values for the coefficients The same result can also be achieved like this:</p><pre><code class="language-julia hljs">function get_coeffs(i) # return the coefficients for bin i
    coeffs = [[2.2, 5.5, 6.6], [2.2, 5.5, 6.6], [2.2, 5.5, 6.6]]
    return coeffs[i]
end

function my_dist_func(params, i)
    coeffs = get_coeffs(i)
    return coeffs[1] * params.C1 + coeffs[2] * params.C1 * params.C2+ coeffs[3] * params.C2
end</code></pre><p>create an array of anonymous functions</p><pre><code class="language-julia hljs">diff_xsec = Function[x -&gt; my_dist_func(x, i) for i in 1:3]</code></pre><h2 id="Using-covariance-matrices"><a class="docs-heading-anchor" href="#Using-covariance-matrices">Using covariance matrices</a><a id="Using-covariance-matrices-1"></a><a class="docs-heading-anchor-permalink" href="#Using-covariance-matrices" title="Permalink"></a></h2><p>Information about the uncertainties of measurements need to be provided to EFTfitter.jl in terms of the uncertainty values and corresponding correlation matrices. If you have these information in terms of covariance matrices, you need to convert it to correlation matrices and uncertainty values before. The function <a href="https://tudo-physik-e4.github.io/EFTfitter.jl/dev/api/#EFTfitter.cov_to_cor-Tuple{Array{var%22#s58%22,2}%20where%20var%22#s58%22%3C:Real}"><code>cov_to_cor</code></a> can be used for this:</p><pre><code class="language-julia hljs">cov_syst = [3.24   0.81   0.378  0.324  0.468;
            0.81   0.81   0.126  0.162  0.234;
            0.378  0.126  0.49   0.126  0.182;
            0.324  0.162  0.126  0.81   0.234;
            0.468  0.234  0.182  0.234  1.69]

cor_syst, unc_syst = cov_to_cor(cov_syst)</code></pre><pre><code class="language-julia hljs">measurements = (

    Meas1 = Measurement(xsec1, 21.6,
            uncertainties = (stat=0.8, syst=unc_syst[1], another_unc=2.3)),

    Meas2 = Measurement(Observable(xsec2, min=0), 1.9,
            uncertainties = (stat=0.6, syst=unc_syst[2], another_unc=1.1), active=true),


    MeasDist = BinnedMeasurement(diff_xsec, [1.9, 2.93, 4.4],
                uncertainties = (stat = [0.7, 1.1, 1.2], syst= unc_syst[3:5], another_unc = [1.0, 1.2, 1.9]),
                active=[true, false, true]),
)</code></pre><h2 id="Nuisance-Correlations"><a class="docs-heading-anchor" href="#Nuisance-Correlations">Nuisance Correlations</a><a id="Nuisance-Correlations-1"></a><a class="docs-heading-anchor-permalink" href="#Nuisance-Correlations" title="Permalink"></a></h2><p>When performing an analysis with unknown correlation coefficients, it is possible to treat them as nuisance parameters in the fit. For this, we define a further <code>NamedTuple</code> consisting of <code>NuisanceCorrelation</code> objects:</p><pre><code class="language-julia hljs">nuisance_correlations = (
    ρ1  = NuisanceCorrelation(:syst, :Meas1, :Meas2, -1..1),
    ρ2  = NuisanceCorrelation(:syst, :MeasDist_bin1, :MeasDist_bin3, truncated(Normal(0.5, 0.1), -1, 1)),
)</code></pre><p>In the <code>NuisanceCorrelation</code> object we specify the name of the uncertainty type, the names of the two measurements we want to correlate using the nuisance correlations and a prior for the nuisance parameter. Note that the nuisance parameters should only be varied in the interval (-1, 1) as they represent correlation coefficients. For <code>ρ1</code> we choose a flat prior between -1 and 1. For <code>ρ2</code> we have some expectations and formulate them using a Gaussian prior with μ=0.5 and σ=0.1. However, to ensure that <code>ρ2</code> is only varied in the allowed region of (-1, 1), we <a href="https://juliastats.org/Distributions.jl/stable/truncate/#Distributions.truncated">truncate</a> the normal distribution accordingly.</p><p>We need to modify the definition of the <code>EFTfitterModel</code> by also passing the <code>nuisance_correlations</code>:</p><pre><code class="language-julia hljs">model = EFTfitterModel(parameters, measurements, correlations, nuisances = nuisance_correlations)


savefig(p, &quot;plot.pdf&quot;)</code></pre><p><img src="../plots/plot_nuisance.png" alt="plot with nuisances"/></p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>When using nuisance correlations, it may happen that the fit does not converge anymore. This happens mainly when the correlation values are close to -1 or +1. In such a case, you can try to reduce the allowed ranges in the priors for the Nuisance correlations to investigate at which values this happens.</p></div></div><h2 id="Ranking-of-measurements-and-uncertainties"><a class="docs-heading-anchor" href="#Ranking-of-measurements-and-uncertainties">Ranking of measurements and uncertainties</a><a id="Ranking-of-measurements-and-uncertainties-1"></a><a class="docs-heading-anchor-permalink" href="#Ranking-of-measurements-and-uncertainties" title="Permalink"></a></h2><p>With the <code>rank_measurements</code> and <code>rank_uncertainties</code> functions, the influence of the individual measurements or uncertainty types on the result of a fit can be estimated. For the ranking, each active measurement (respectively uncertainty type) is deactivated at a time and the fit is repeated. The results of the fits with a deactivated measurement (or uncertainty type) are then compared to the fit result with all measurements (uncertainty types) activated. A ranking is calculated based on a ranking criterion calculated from the posterior distributions of these fits.</p><p>The default ranking criterion is the relative increase of the total width of the smallest interval containing 90% of the posterior probability when deactivating a measurement. For models with more than one parameter, the sum of the relative increases of all one-dimensional smallest intervals is used, i.e. <code>SumOfSmallestIntervals(p=0.9, bins=200)</code>.</p><pre><code class="language-julia hljs">measurement_ranking = EFTfitter.rank_measurements(model)</code></pre><p>The sampling algorithm to be used can be passed with the keyword <code>sampling_algorithm</code>. By default, <code>BAT.MCMCSampling()</code> is used, i.e. Metropolis-Hastings with 4 chains and 100000 steps.</p><pre><code class="language-julia hljs">plot(measurement_ranking, title = &quot;Ranking of measurements&quot;)</code></pre><p><img src="../plots/meas_ranks.png" alt="measurement ranking"/></p><p>For ranking the uncertainty types, the relative decrease is used.</p><pre><code class="language-julia hljs">uncertainty_ranking = EFTfitter.rank_uncertainties(model,
    criterion = SumOfSmallestIntervals(p=0.9, bins=200),
    sampling_algorithm = SobolSampler(nsamples = 10^5), order = :values)

plot(uncertainty_ranking, title = &quot;Ranking of uncertainty types&quot;)</code></pre><p><img src="../plots/unc_ranks.png" alt="measurement ranking"/> Please see the <a href="https://tudo-physik-e4.github.io/EFTfitter.jl/dev/api/#EFTfitter.rank_measurements">ranking documentation</a> for further ranking criteria and keyword arguments.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tutorial/">« Tutorial</a><a class="docs-footer-nextpage" href="../BLUE/">BLUE Example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Tuesday 7 November 2023 07:59">Tuesday 7 November 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
